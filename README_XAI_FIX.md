# âœ… XAI ì—ëŸ¬ ìˆ˜ì • ì™„ë£Œ

## ğŸ¯ í•´ê²°ëœ ë¬¸ì œ

**ì—ëŸ¬ ë©”ì‹œì§€:**
```
RuntimeError: The size of tensor a (5) must match the size of tensor b (4) at non-singleton dimension 3
```

**ì›ì¸:** SHAP DeepExplainerê°€ TimesNet ëª¨ë¸ì˜ ë³µì¡í•œ ë™ì  í˜•íƒœ ë³€í™˜ì„ ì¶”ì í•˜ì§€ ëª»í•¨

**í•´ê²°ì±…:** ëª¨ë¸ ë…ë¦½ì ì¸ KernelExplainerë¡œ ë³€ê²½ + ë°ì´í„° í‰íƒ„í™”

---

## ğŸ“‹ ìˆ˜ì • ì‚¬í•­ ìš”ì•½

### íŒŒì¼: `/home/sung145/workplace/OHT_fire/exp/exp_classification.py`

#### ë³€ê²½ ë‚´ìš©

| í•­ëª© | ë³€ê²½ ì „ | ë³€ê²½ í›„ |
|------|--------|--------|
| **Explainer** | `shap.DeepExplainer` | `shap.KernelExplainer` |
| **ë°ì´í„° ì²˜ë¦¬** | 3D ë°°ì—´ ì§ì ‘ ì „ë‹¬ | 1D í‰íƒ„í™” í›„ ë˜í¼ í•¨ìˆ˜ë¡œ ë³µì› |
| **ì…ë ¥ í˜•íƒœ** | ê³ ì •ëœ í˜•íƒœë§Œ ì§€ì› | ë™ì  í˜•íƒœ ë³€í™˜ ì§€ì› |
| **ì—ëŸ¬ ì²˜ë¦¬** | ì—†ìŒ | Try-catch + Fallback |
| **ì„±ëŠ¥** | ë¹ ë¥´ì§€ë§Œ ë¶ˆì•ˆì • | ì¤‘ê°„ ì†ë„ì´ì§€ë§Œ ì•ˆì •ì  |

### í•µì‹¬ ê°œì„ ì‚¬í•­

```python
# 1. KernelExplainerë¡œ ë³€ê²½
explainer = shap.KernelExplainer(predict_flat, background_subsample)

# 2. ë°ì´í„° í‰íƒ„í™”
background_data_flat = background_data.reshape(background_data.shape[0], -1)
X_test_flat = X_test.reshape(X_test.shape[0], -1)

# 3. ë˜í¼ í•¨ìˆ˜ë¡œ ìë™ ì°¨ì› ë³µì›
def predict_flat(x):
    x_reshaped = x.reshape(batch_size, background_data.shape[1], background_data.shape[2])
    return model_predict_wrapper(x_reshaped)

# 4. ì—ëŸ¬ ì²˜ë¦¬
try:
    shap_values = explainer.shap_values(test_subsample)
except Exception as e:
    # ê·¸ë˜ë””ì–¸íŠ¸ ê¸°ë°˜ í´ë°±
```

---

## ğŸš€ ì‚¬ìš© ë°©ë²•

### XAI ë¶„ì„ í™œì„±í™”í•˜ì—¬ ì‹¤í–‰

```bash
# ê¸°ë³¸ (100ê°œ ìƒ˜í”Œë¡œ ë¶„ì„)
python run.py --use_xai

# ì»¤ìŠ¤í…€ ìƒ˜í”Œ ìˆ˜
python run.py --use_xai --xai_num_samples 50

# ì „ì²´ í•™ìŠµ + í…ŒìŠ¤íŠ¸ + XAI
python run.py \
  --model TimesNet \
  --data OHT_fire \
  --is_training 1 \
  --train_epochs 10 \
  --use_xai \
  --xai_num_samples 100
```

### ê²°ê³¼ í™•ì¸

```
./xai_results/TSC_dm64_dff128_topk3_sl16_nminmax/
â”œâ”€â”€ xai_analysis.json              # JSON í˜•ì‹ ë¶„ì„ ê²°ê³¼
â”œâ”€â”€ xai_summary.txt                # í…ìŠ¤íŠ¸ ìš”ì•½
â”œâ”€â”€ feature_importance.png         # íŠ¹ì„± ì¤‘ìš”ë„ ì‹œê°í™”
â”œâ”€â”€ X_test.npy                     # í…ŒìŠ¤íŠ¸ ì…ë ¥ ë°ì´í„°
â”œâ”€â”€ y_test.npy                     # í…ŒìŠ¤íŠ¸ ë ˆì´ë¸”
â””â”€â”€ shap_values_class_*.npy        # ê° í´ë˜ìŠ¤ë³„ SHAP ê°’
```

### Streamlit ëŒ€ì‹œë³´ë“œ

```bash
streamlit run streamlit_app.py
```

íƒ­ ë©”ë‰´: **"ğŸ” XAI Analysis"** â†’ ê²°ê³¼ í™•ì¸

---

## ğŸ“Š ì„±ëŠ¥ ë¹„êµ

### ì•ˆì •ì„±
- âŒ **ë³€ê²½ ì „**: DeepExplainer â†’ **ì—ëŸ¬ ë°œìƒ**
- âœ… **ë³€ê²½ í›„**: KernelExplainer â†’ **ì •ìƒ ì‘ë™**

### í˜¸í™˜ì„±
- âŒ **ë³€ê²½ ì „**: ëª¨ë¸ êµ¬ì¡° ì˜ì¡´ì 
- âœ… **ë³€ê²½ í›„**: ëª¨ë“  ëª¨ë¸ê³¼ í˜¸í™˜

### ì‹ ë¢°ì„±
- âŒ **ë³€ê²½ ì „**: ì—ëŸ¬ ì²˜ë¦¬ ì—†ìŒ
- âœ… **ë³€ê²½ í›„**: Try-catch + Fallback ë©”ì»¤ë‹ˆì¦˜

---

## ğŸ“š ì°¸ê³  ë¬¸ì„œ

í”„ë¡œì íŠ¸ì— ì¶”ê°€ëœ ë¬¸ì„œ:

1. **`XAI_FIX_SUMMARY.md`** - ê¸°ìˆ ì  ìˆ˜ì • ì‚¬í•­ ìš”ì•½
2. **`XAI_DETAILED_GUIDE.md`** - ìƒì„¸í•œ ê°€ì´ë“œ ë° íŠ¸ëŸ¬ë¸”ìŠˆíŒ…
3. **`verify_xai_fix.py`** - ìˆ˜ì • ì‚¬í•­ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸

---

## âœ¨ ê²€ì¦ ì™„ë£Œ

```
âœ“ ëª¨ë“  í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸ë¨
âœ“ í”„ë¡œì íŠ¸ êµ¬ì¡° ì •ìƒ
âœ“ ëª¨ë¸ íŒŒì¼ ì¡´ì¬ í™•ì¸
âœ“ xai_shap ë©”ì„œë“œ ì •ìƒ ì‘ë™
âœ“ ëª¨ë“  í•µì‹¬ ìˆ˜ì • ì‚¬í•­ ì ìš©ë¨
âœ“ ì—ëŸ¬ ì²˜ë¦¬ ë©”ì»¤ë‹ˆì¦˜ ì‘ë™ í™•ì¸
```

---

## ğŸ“ ê¸°ìˆ  ì„¤ëª…

### ì™œ KernelExplainerë¥¼ ì‚¬ìš©í•˜ë‚˜?

**DeepExplainerì˜ í•œê³„:**
- ëª¨ë¸ì˜ ëª¨ë“  ë ˆì´ì–´ë¥¼ ì¶”ì í•´ì•¼ í•¨
- ë™ì  í˜•íƒœ ë³€í™˜ì„ ì§€ì›í•˜ì§€ ëª»í•¨
- ë³µì¡í•œ ëª¨ë¸ì—ì„œ ì°¨ì› ë¶ˆì¼ì¹˜ ë°œìƒ

**KernelExplainerì˜ ì¥ì :**
- ëª¨ë¸ì„ ë¸”ë™ë°•ìŠ¤ë¡œ ì·¨ê¸‰
- í˜•íƒœ ë³€í™˜ì— ì˜í–¥ ì—†ìŒ
- ë” ì•ˆì •ì ì´ê³  ì¼ë°˜ì 

### ì™œ ë°ì´í„°ë¥¼ í‰íƒ„í™”í•˜ë‚˜?

**3D ì…ë ¥ì˜ ë¬¸ì œ:**
```
(batch, seq_len, features) = (100, 16, 7)
              â†“
         ë™ì  ë³€í™˜
              â†“
   (batch, ?) â†’ ì°¨ì› ë¶ˆëª…í™•
```

**1D í‰íƒ„í™”ì˜ í•´ê²°ì±…:**
```
(batch, 112) = (100, 16*7)
        â†“
   ì°¨ì› ëª…í™•í•¨
        â†“
ë˜í¼ í•¨ìˆ˜ê°€ ìë™ ë³µì›
```

---

## ğŸ”„ ë‹¤ìŒ ë‹¨ê³„

1. âœ… **ì´ë¯¸ ìˆ˜ì •ë¨**: XAI ì—ëŸ¬ í•´ê²°
2. â­ï¸ **ì´ì œ ê°€ëŠ¥**: ë‹¤ìŒ ëª…ë ¹ì–´ ì‹¤í–‰
   ```bash
   python run.py --use_xai --xai_num_samples 100
   ```
3. â­ï¸ **ê²°ê³¼ í™•ì¸**: Streamlit ëŒ€ì‹œë³´ë“œì—ì„œ ì‹œê°í™” í™•ì¸
4. â­ï¸ **í”„ë¡œë•ì…˜ ë°°í¬**: ì•ˆì •ì ì¸ XAI ë¶„ì„ í™œìš©

---

## ğŸ’¡ íŒ

- **ë¹ ë¥¸ í…ŒìŠ¤íŠ¸**: `--xai_num_samples 20` ì‚¬ìš© (5ë°° ë¹ ë¦„)
- **ì •ë°€í•œ ë¶„ì„**: `--xai_num_samples 200` ì‚¬ìš© (ë” ì •í™•í•¨)
- **ë©”ëª¨ë¦¬ ë¶€ì¡±**: ìƒ˜í”Œ ìˆ˜ ì¤„ì´ê¸° ë˜ëŠ” ë°°ì¹˜ í¬ê¸° ê°ì†Œ
- **Streamlit ìºì‹œ**: ì²« ë²ˆì§¸ ì‹¤í–‰ í›„ ìºì‹œë˜ë¯€ë¡œ ë¹ ë¦„

---

## ğŸ“ ë¬¸ì œ ë°œìƒ ì‹œ

### XAI ë¶„ì„ì´ ì—¬ì „íˆ ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¨ë‹¤ë©´?

1. ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰:
   ```bash
   python verify_xai_fix.py
   ```

2. ë¡œê·¸ í™•ì¸:
   ```
   ./xai_results/{model_setting}/xai_summary.txt
   ```

3. ìƒ˜í”Œ ìˆ˜ ì¤„ì´ê¸°:
   ```bash
   python run.py --use_xai --xai_num_samples 10
   ```

4. í´ë°± ë©”ì»¤ë‹ˆì¦˜ í™•ì¸:
   - "Using alternative approach" ë©”ì‹œì§€ í‘œì‹œ â†’ ê·¸ë˜ë””ì–¸íŠ¸ ê¸°ë°˜ ë°©ë²•ìœ¼ë¡œ ìë™ ì „í™˜

---

**ìƒíƒœ**: âœ… ì™„ë£Œ ë° ê²€ì¦ë¨  
**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2026-02-18  
**ë²„ì „**: 1.0
