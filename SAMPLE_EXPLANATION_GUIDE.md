# ìƒ˜í”Œë³„ XAI ì„¤ëª… ê°€ì´ë“œ (Instance-Level SHAP)

## ğŸ¯ ê°œìš”

ê¸°ì¡´ì˜ **Global Feature Importance** (ëª¨ë“  í´ë˜ìŠ¤/ìƒ˜í”Œì— ëŒ€í•œ í‰ê· )ì—ì„œ 
**Instance-Level SHAP Explanation** (íŠ¹ì • ìƒ˜í”Œì´ íŠ¹ì • í´ë˜ìŠ¤ë¡œ ì˜ˆì¸¡ëœ ì´ìœ )ìœ¼ë¡œ í™•ì¥í–ˆìŠµë‹ˆë‹¤.

## ğŸ“Š ì´ì „ vs í˜„ì¬

### ì´ì „ (Global Explanation)
```
Class 0ì— ëŒ€í•´ ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” feature ìˆœì„œ
Class 1ì— ëŒ€í•´ ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” feature ìˆœì„œ
Class 2ì— ëŒ€í•´ ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” feature ìˆœì„œ
Class 3ì— ëŒ€í•´ ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” feature ìˆœì„œ
```
â†’ **ëª¨ë“  ìƒ˜í”Œì— ëŒ€í•œ í‰ê·  íŠ¹ì„± ì¤‘ìš”ë„**

### í˜„ì¬ (Instance-Level Explanation)
```
ìƒ˜í”Œ 1ì´ Class 0ìœ¼ë¡œ ì˜ˆì¸¡ëœ ì´ìœ 
  - Feature 3: 0.1234
  - Feature 5: 0.0987
  - Feature 2: 0.0765
  ...

ìƒ˜í”Œ 2ê°€ Class 2ë¡œ ì˜ˆì¸¡ëœ ì´ìœ 
  - Feature 7: 0.1456
  - Feature 1: 0.1102
  - Feature 4: 0.0834
  ...
```
â†’ **íŠ¹ì • ìƒ˜í”Œì˜ ì˜ˆì¸¡ ì´ìœ ë¥¼ ëª…í™•í•˜ê²Œ ì„¤ëª…**

## ğŸš€ ì‚¬ìš© ë°©ë²•

### 1. XAI ë¶„ì„ ì‹¤í–‰
```bash
python run.py --use_xai --xai_num_samples 100
```

ê²°ê³¼ ìƒì„± ìœ„ì¹˜:
```
./xai_results/{model_setting}/
â”œâ”€â”€ sample_explanations.json  # â† ìƒˆë¡œ ìƒì„±ë˜ëŠ” íŒŒì¼!
â””â”€â”€ xai_analysis.json
```

### 2. Streamlit ëŒ€ì‹œë³´ë“œ ì‹¤í–‰
```bash
streamlit run streamlit_app.py
```

### 3. ìƒˆë¡œìš´ "ğŸ¯ Sample Explanation" íƒ­ìœ¼ë¡œ ì´ë™

## ğŸ“‹ Sample Explanation íƒ­ ê¸°ëŠ¥

### A. ìƒ˜í”Œ ì„ íƒ
- ë“œë¡­ë‹¤ìš´ì—ì„œ ë¶„ì„í•  ìƒ˜í”Œ ì„ íƒ
- í˜•ì‹: `Sample {ë²ˆí˜¸} â†’ Predicted: Class {ì˜ˆì¸¡í´ë˜ìŠ¤} (True: Class {ì‹¤ì œí´ë˜ìŠ¤})`
- "Show all samples" ì²´í¬ë°•ìŠ¤ë¡œ ëª¨ë“  ìƒ˜í”Œ í•œ ë²ˆì— ë³´ê¸°

### B. í‘œì‹œë˜ëŠ” ì •ë³´

#### 1ï¸âƒ£ ê¸°ë³¸ ì •ë³´ (ë©”íŠ¸ë¦­)
- **Predicted Class**: ëª¨ë¸ì´ ì˜ˆì¸¡í•œ í´ë˜ìŠ¤ + ì‹ ë¢°ë„
- **True Class**: ì‹¤ì œ ë ˆì´ë¸” (âœ… ë§ìŒ / âŒ í‹€ë¦¼)
- **2nd Highest Class**: ë‘ ë²ˆì§¸ ë†’ì€ í™•ë¥ ì˜ í´ë˜ìŠ¤
- **Confidence Margin**: 1ìˆœìœ„ì™€ 2ìˆœìœ„ì˜ í™•ë¥  ì°¨ì´

#### 2ï¸âƒ£ í´ë˜ìŠ¤ í™•ë¥  ë¶„í¬
```
Class 0: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 75%
Class 1: â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘ 15%
Class 2: â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  8%
Class 3: â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  2%
```

#### 3ï¸âƒ£ ìƒìœ„ íŠ¹ì„± (Top 5)
ì˜ˆì¸¡ì— ê°€ì¥ í¬ê²Œ ì˜í–¥ì„ ë¯¸ì¹œ 5ê°œì˜ íŠ¹ì„±ì„ ì‹œê°í™”
- ê¸°ì—¬ë„ ìˆœì„œ
- ê° íŠ¹ì„±ì˜ ê¸°ì—¬ë„ í¬ê¸° (ì ˆëŒ“ê°’ |SHAP|)

#### 4ï¸âƒ£ íŠ¹ì„±ë³„ ê¸°ì—¬ë„ í…Œì´ë¸”
| Rank | Feature Index | Contribution Score | Relative Importance |
|------|---|---|---|
| 1 | 3 | 0.1234 | 100% |
| 2 | 5 | 0.0987 | 80% |
| ... | ... | ... | ... |

#### 5ï¸âƒ£ ëª¨ë“  íŠ¹ì„± ê¸°ì—¬ë„ íˆíŠ¸ë§µ
ëª¨ë“  íŠ¹ì„±ì˜ ê¸°ì—¬ë„ë¥¼ í•œëˆˆì— ë³´ëŠ” ìƒ‰ìƒ ë§µ
- ë¹¨ê°•: ë†’ì€ ê¸°ì—¬ë„
- ì´ˆë¡: ë‚®ì€ ê¸°ì—¬ë„

#### 6ï¸âƒ£ í•´ì„ ìš”ì•½
```
Summary: ì´ ìƒ˜í”Œì€ Class 0ìœ¼ë¡œ ì˜ˆì¸¡ë˜ì—ˆê³ , 
ì‹ ë¢°ë„ëŠ” 75.3%ì…ë‹ˆë‹¤.

Top Contributing Features: ì£¼ìš” ê¸°ì—¬ íŠ¹ì„±ë“¤:
1. Feature 3 (score: 0.1234)
2. Feature 5 (score: 0.0987)
3. Feature 2 (score: 0.0765)

Prediction Confidence: 1ìˆœìœ„ì™€ 2ìˆœìœ„ì˜ ì°¨ì´ëŠ” 
60.3%ë¡œ ê°•í•œ ì˜ˆì¸¡ì…ë‹ˆë‹¤.

Correctness: âœ… CORRECT
```

## ğŸ” JSON êµ¬ì¡° (sample_explanations.json)

```json
[
  {
    "sample_idx": 0,
    "predicted_class": 0,
    "predicted_probability": 0.753,
    "true_class": 0,
    "is_correct": true,
    "all_class_probabilities": {
      "class_0": 0.753,
      "class_1": 0.150,
      "class_2": 0.080,
      "class_3": 0.017
    },
    "contrast_class": 1,
    "contrast_probability": 0.150,
    "top_contributing_features": [
      {
        "feature_idx": 3,
        "contribution_magnitude": 0.1234
      },
      {
        "feature_idx": 5,
        "contribution_magnitude": 0.0987
      },
      ...
    ],
    "feature_contribution_scores": [0.001, 0.002, 0.123, ...]
  },
  ...
]
```

## ğŸ’¡ í™œìš© ì‚¬ë¡€

### ì˜ˆì‹œ 1: ì˜¤ë¶„ë¥˜ ìƒ˜í”Œ ë¶„ì„
```
âŒ ì˜ëª»ëœ ì˜ˆì¸¡ ìƒ˜í”Œì„ ì„ íƒí•˜ë©´:
- ì™œ ëª¨ë¸ì´ ì´ë ‡ê²Œ ì˜ˆì¸¡í–ˆëŠ”ì§€ ì´í•´
- ì–´ë–¤ íŠ¹ì„±ì´ ì˜¤ë„í–ˆëŠ”ì§€ í™•ì¸
- ëª¨ë¸ ê°œì„  ë°©í–¥ ë°œê²¬
```

### ì˜ˆì‹œ 2: ëª¨ìˆœì ì¸ ì˜ˆì¸¡
```
ì˜ˆì¸¡ í™•ë¥ ì´ ë¹„ìŠ·í•œ ìƒ˜í”Œ:
- Class 0: 45%
- Class 1: 42%

ì–´ë–¤ íŠ¹ì„±ë“¤ì´ ì´ ë‘˜ì„ êµ¬ë¶„í•˜ëŠ”ì§€ í™•ì¸
â†’ ëª¨ë¸ì˜ ì˜ì‚¬ê²°ì • ê²½ê³„ ì´í•´
```

### ì˜ˆì‹œ 3: íŠ¹ì • íŒ¨í„´ ì¸ì‹
```
ì—¬ëŸ¬ ìƒ˜í”Œì„ ë¹„êµí•˜ë©´:
- ê° í´ë˜ìŠ¤ë¥¼ êµ¬ë¶„í•˜ëŠ” í•µì‹¬ íŠ¹ì„± ë°œê²¬
- íŠ¹ì„± ê°„ ìƒí˜¸ì‘ìš© íŒ¨í„´ íŒŒì•…
- ë„ë©”ì¸ ì§€ì‹ ê²€ì¦
```

## ğŸ“ˆ ë¹„êµ: Global vs Instance-Level

| í•­ëª© | Global (í´ë˜ìŠ¤ë³„) | Instance-Level (ìƒ˜í”Œë³„) |
|------|---|---|
| **ëª©ì ** | ì „ì²´ íŒ¨í„´ ì´í•´ | ê°œë³„ ì˜ˆì¸¡ ì´í•´ |
| **íŠ¹ì„± ìˆœìœ„** | ëª¨ë“  ìƒ˜í”Œì˜ í‰ê·  | íŠ¹ì • ìƒ˜í”Œì˜ ì‹¤ì œ ì˜í–¥ |
| **í™œìš©** | ëª¨ë¸ íŠ¹ì„± ì´í•´ | ì˜¤ë¥˜ ë¶„ì„, ë””ë²„ê¹… |
| **ì˜ˆì‹œ** | í´ë˜ìŠ¤ 0ì˜ top 3 íŠ¹ì„± | ìƒ˜í”Œ 5ê°€ í´ë˜ìŠ¤ 0ìœ¼ë¡œ ì˜ˆì¸¡ëœ ì´ìœ  |

## ğŸ”§ í™•ì¸/ê²€ì¦

ìƒ˜í”Œ ì„¤ëª…ì´ ì œëŒ€ë¡œ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸:
```bash
python verify_sample_explanations.py
```

ì¶œë ¥:
```
âœ“ sample_explanations.json found
âœ“ JSON loaded successfully
  Total samples: 100

ğŸ“‹ First Sample Explanation Structure:
  - sample_idx: 0
  - predicted_class: 0
  - predicted_probability: 75.30%
  - true_class: 0
  - is_correct: True
  ...
```

## ğŸ“ SHAP ê°œë… ì •ë¦¬

### Instance-Level SHAP valuesë€?
- **ìƒ˜í”Œë³„ë¡œ ê³„ì‚°ëœ** SHAP ê°’
- ê° íŠ¹ì„±ì´ **íŠ¹ì • ìƒ˜í”Œ**ì˜ **íŠ¹ì • ì˜ˆì¸¡**ì— ì–¼ë§ˆë‚˜ ê¸°ì—¬í–ˆëŠ”ì§€ ì •ëŸ‰í™”
- ì˜ˆì¸¡ì„ baselineì—ì„œ ì‹¤ì œ ì˜ˆì¸¡ê°’ê¹Œì§€ ë³€ê²½í•˜ëŠ” ê° íŠ¹ì„±ì˜ ê¸°ì—¬ë„

### ì˜ˆì‹œ
```
Sample: [0.5, 0.7, 0.3, 0.9, 0.2]
Baseline prediction: 0.5 (ë¬´ì‘ìœ„)

Prediction: Class 0 (75%)
  = Baseline (50%)
  + Feature 3 contribution (+15%)
  + Feature 0 contribution (+8%)
  + Feature 1 contribution (+2%)
  = 75%
```

## ğŸ“ íŒŒì¼ ì‹œìŠ¤í…œ

```
xai_results/
â””â”€â”€ TSC_dm64_dff128_topk3_sl16_nminmax/
    â”œâ”€â”€ sample_explanations.json        â† ìƒ˜í”Œë³„ ì„¤ëª… (NEW!)
    â”œâ”€â”€ xai_analysis.json               â† ì „ì²´ ë¶„ì„ ê²°ê³¼ (ê¸°ì¡´)
    â”œâ”€â”€ feature_importance.png          â† ì „ì—­ íŠ¹ì„± ì¤‘ìš”ë„
    â”œâ”€â”€ X_test.npy
    â”œâ”€â”€ y_test.npy
    â””â”€â”€ shap_values_class_*.npy
```

## ğŸš€ ë‹¤ìŒ ë‹¨ê³„

1. âœ… XAI ë¶„ì„ ì¬ì‹¤í–‰
2. âœ… Streamlit ëŒ€ì‹œë³´ë“œ ì‹¤í–‰
3. âœ… "ğŸ¯ Sample Explanation" íƒ­ í™•ì¸
4. âœ… ê´€ì‹¬ìˆëŠ” ìƒ˜í”Œ ë¶„ì„
5. â­ï¸ ì˜¤ë¥˜ ë¶„ì„ ë° ëª¨ë¸ ê°œì„ 

---

**ì—…ë°ì´íŠ¸**: 2026-02-18  
**ë²„ì „**: 2.0 (Instance-Level Explanation ì¶”ê°€)
